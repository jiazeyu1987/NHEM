# 波形截取功能数据流图

## 总体数据流架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              波形截取数据流                                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1. 用户交互层 (Frontend)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户界面交互                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

用户操作流程:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户设置参数   │───▶│   点击截取按钮   │───▶│   等待截取结果   │
│                 │    │                 │    │                 │
│ • 窗口大小:      │    │ • 触发API调用   │    │ • 显示截取数据   │
│   50-200帧      │    │ • 显示加载状态   │    │ • 更新UI状态    │
│ • 数据源选择:    │    │ • 禁用按钮防抖   │    │ • 显示成功动画   │
│   ROI/主信号    │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        WaveformCapture 类                                     │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                   │
│ │ captureSettings │ │ UI Elements     │ │ Event Handlers  │                   │
│ │                 │ │                 │ │                 │                   │
│ │ • windowSize    │ │ • 滑块控件      │ │ • 滑块变化      │                   │
│ │ • dataSource    │ │ • 截取按钮      │ │ • 截取按钮点击  │                   │
│ │ •...           │ │ • 状态指示器    │ │ • 清除按钮点击  │                   │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2. API调用层 (Frontend → Backend)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API请求发送                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

根据数据源选择不同API端点:

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API路由选择                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                     数据源判断                                  │
    │                                                                 │
    │ if (dataSource === 'roi') {                                    │
    │     // ROI数据源 - 需要ROI配置完成                               │
    │     return '/data/roi-window-capture-with-peaks';                │
    │ } else {                                                         │
    │     // 主信号数据源                                               │
    │     return '/data/window-capture';                               │
    │ }                                                                │
    └─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────┬─────────────────────────────────────┐
│     ROI数据截取API           │      主信号数据截取API               │
│                             │                                     │
│ GET /data/roi-window-       │ GET /data/window-capture             │
│ capture-with-peaks           │                                     │
│                             │                                     │
│ 参数:                        │ 参数:                                │
│ • count: 100 (窗口大小)      │ • count: 100 (窗口大小)             │
│ • threshold: 110.5          │                                     │
│ • margin_frames: 6          │                                     │
│ • difference_threshold: 2.3 │                                     │
└─────────────────────────────┴─────────────────────────────────────┘
```

### 3. 后端处理层 (Backend)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              后端API处理                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           API路由层 (routes.py)                                │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         窗口截取端点                                        │ │
│ │                                                                             │ │
│ │ @router.get("/data/window-capture")                                         │ │
│ │ └──▶ 主信号数据截取                                                          │ │
│ │                                                                             │ │
│ │ @router.get("/data/roi-window-capture")                                    │ │
│ │ └──▶ ROI数据截取                                                             │ │
│ │                                                                             │ │
│ │ @router.get("/data/roi-window-capture-with-peaks")                         │ │
│ │ └──▶ ROI数据截取 + 波峰检测                                                  │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           数据存储层 (data_store.py)                           │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         数据获取方法                                        │ │
│ │                                                                             │ │
│ │ get_series(count)                     get_roi_series(count)                │ │
│ │ └──▶ 获取主信号历史数据                    └──▶ 获取ROI历史数据                 │ │
│ │     • 从_frames缓冲区读取                     • 从_roi_frames缓冲区读取        │ │
│ │     • 返回最近count个Frame                   • 返回最近count个RoiFrame        │ │
│ │     • Frame: (index, timestamp, value)      • RoiFrame: 包含灰度值等        │ │
│ │                                                                             │ │
│ │ 缓冲区特性:                                                                 │ │
│ │ • _frames: 主信号数据 (默认100帧)                                           │ │
│ │ • _roi_frames: ROI数据 (默认500帧)                                          │ │
│ │ • 线程安全: threading.Lock()                                                │ │
│ │ • 循环缓冲: deque(maxlen=buffer_size)                                       │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4. 波峰检测处理 (仅ROI截取)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            波峰检测流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

当使用ROI数据截取时，触发波峰检测:

┌─────────────────────────────────────────────────────────────────────────────────┐
│                      EnhancedPeakDetector                                      │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         波峰检测算法                                        │ │
│ │                                                                             │ │
│ │ 输入: ROI灰度值序列                                                          │ │
│ │ 输出: 波峰位置、分类、评分                                                    │ │
│ │                                                                             │ │
│ │ 检测步骤:                                                                   │ │
│ │ 1. 数据预处理                                                               │ │
│ │    • 灰度值序列提取                                                         │ │
│ │    • 数据验证                                                               │ │
│ │                                                                             │ │
│ │ 2. 多算法检测                                                               │ │
│ │    • threshold_method: 阈值法                                              │ │
│ │    • morphological_method: 形态学法                                         │ │
│ │    • slope_method: 斜率法                                                   │ │
│ │                                                                             │ │
│ │ 3. 波峰分类                                                                 │ │
│ │    • 绿色波峰: 稳定、高置信度                                                │ │
│ │    • 红色波峰: 不稳定、低置信度                                              │ │
│ │                                                                             │ │
│ │ 4. 质量评分                                                                 │ │
│ │    • 基于幅度、形态、稳定性                                                  │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            结果封装                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

波峰检测结果结构:
{
    "peaks": [
        {
            "index": 45,
            "gray_value": 156.7,
            "main_frame": 892,
            "roi_frame": 34,
            "type": "green",
            "confidence": 0.85,
            "score": 0.92,
            "threshold": 110.5,
            "in_peak_region": true,
            "frame_count": 897
        }
        // ... 更多波峰
    ],
    "detection_summary": {
        "total_peaks": 3,
        "green_peaks": 2,
        "red_peaks": 1,
        "peak_indices": [23, 45, 67],
        "average_confidence": 0.78,
        "detection_rate": 0.95
    }
}
```

### 5. 响应数据封装

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            响应模型                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

主信号截取响应 (WindowCaptureResponse):
{
    "type": "window_capture",
    "timestamp": "2025-12-05T12:00:00Z",
    "window_size": 100,
    "frame_range": (800, 899),
    "series": [
        {
            "t": 17.78,
            "value": 123.45
        }
        // ... 100个数据点
    ],
    "capture_metadata": {
        "duration": 2.22,
        "fps": 45.0,
        "value_range": [45.2, 167.8]
    },
    "success": true,
    "message": "Window data captured successfully"
}

ROI截取响应 (RoiWindowCaptureWithPeaksResponse):
{
    "type": "roi_window_capture_with_peaks",
    "timestamp": "2025-12-05T12:00:00Z",
    "window_size": 100,
    "roi_frame_range": (45, 144),
    "main_frame_range": (800, 899),
    "series": [
        {
            "t": 17.78,
            "gray_value": 134.56,
            "roi_index": 45
        }
        // ... 100个ROI数据点
    ],
    "roi_config": {
        "x1": 10, "y1": 20, "x2": 210, "y2": 170,
        "width": 200, "height": 150
    },
    "capture_metadata": {
        "capture_duration": 2.22,
        "actual_roi_fps": 5.0,
        "available_roi_frames": 342
    },
    "peak_detection_results": { /* 波峰检测结果 */ },
    "peak_detection_params": { /* 检测参数 */ },
    "success": true,
    "message": "ROI window data captured with peak detection analysis"
}
```

### 6. 前端数据处理和显示

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          前端数据处理                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

API响应处理流程:

┌─────────────────────────────────────────────────────────────────────────────────┐
│                      displayCapturedData()                                    │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         数据处理步骤                                        │ │
│ │                                                                             │ │
│ │ 1. 数据验证                                                                 │ │
│ │    • 检查response.success                                                   │ │
│ │    • 验证数据完整性                                                         │ │
│ │                                                                             │ │
│ │ 2. 元数据提取                                                               │ │
│ │    • frame_count, duration, value_range                                     │ │
│ │    • roi_frame_range, main_frame_range                                      │ │
│ │                                                                             │ │
│ │ 3. 波峰分析 (仅ROI数据)                                                     │ │
│ │    • 检查波峰数量                                                           │ │
│ │    • 分析截取点附近的波峰                                                    │ │
│ │    • 确定子波形颜色                                                         │ │
│ │                                                                             │ │
│ │ 4. UI更新                                                                  │ │
│ │    • 显示截取信息面板                                                       │ │
│ │    • 更新统计数据                                                           │ │
│ │    • 渲染子波形图表                                                         │ │
│ │    • 显示成功动画                                                           │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          图表渲染                                              │
└─────────────────────────────────────────────────────────────────────────────────┘

子波形图表渲染:

┌─────────────────────────────────────────────────────────────────────────────────┐
│                      SubWaveformChart                                        │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │                         渲染特性                                            │ │
│ │                                                                             │ │
│ │ • 数据点数量: 100个 (可配置50-200)                                          │ │
│ │ • Y轴范围: 自适应 (根据数据范围)                                            │ │
│ │ • X轴范围: 时间轴 (0到duration)                                             │ │
│ │ • 波峰标记: 绿色/红色圆点 (仅ROI数据)                                       │ │
│ │ • 颜色方案:                                                               │ │
│ │   - 绿色: 截取点附近有稳定波峰                                                │ │
│ │   - 红色: 截取点附近有不稳波峰                                                │ │
│ │   - 默认蓝色: 无波峰或主信号数据                                             │ │
│ │                                                                             │ │
│ │ • 悬停信息:                                                                 │ │
│ │   "截取波形 | 索引: {index} | 时间: {t}s | 数值: {value}"                   │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7. 完整数据流时序图

```
用户操作                     前端处理                       后端处理                     数据存储
    │                          │                            │                            │
    │ 设置窗口大小              │                            │                            │
    ├─────────────────────────►│                            │                            │
    │                          │ 更新captureSettings        │                            │
    │                          │ windowSize = newValue      │                            │
    │                          │                            │                            │
    │ 点击截取按钮              │                            │                            │
    ├─────────────────────────►│                            │                            │
    │                          │ captureWaveform()          │                            │
    │                          ├─────────────────────────►│                            │
    │                          │ HTTP GET /api/...          │                            │
    │                          │                            │ 路由处理                   │
    │                          │                            ├─────────────────────────►│
    │                          │                            │ get_series(count)          │
    │                          │                            │ 或                         │
    │                          │                            │ get_roi_series(count)      │
    │                          │                            │                            │
    │                          │                            │ ◄─────────────────────────┤
    │                          │                            │ 返回Frame/RoiFrame数据      │
    │                          │                            │                            │
    │                          │                            │ 波峰检测 (ROI)             │
    │                          │                            │ enhanced_peak_detector     │
    │                          │                            │                            │
    │                          │ ◄─────────────────────────┤ 返回封装的响应数据          │
    │                          │                            │                            │
    │                          │ displayCapturedData()      │                            │
    │                          ├─────────────────────────►│                            │
    │                          │ 渲染子波形图表              │                            │
    │                          │ 更新UI状态                 │                            │
    │                          │                            │                            │
    │ 显示截取结果              │                            │                            │
    │ ◄─────────────────────────┤                            │                            │
    │                          │                            │                            │
```

## 关键性能指标

- **API响应时间**: < 100ms (数据获取 + 处理)
- **前端渲染时间**: < 50ms (Canvas绘制)
- **内存使用**:
  - 主信号缓冲: 100帧 × Frame结构
  - ROI缓冲: 500帧 × RoiFrame结构
- **数据准确性**:
  - 时间戳精度: 毫秒级
  - 数值精度: 浮点数
  - 帧索引连续性: 保证

## 错误处理流程

```
错误类型                    处理方式
─────────────────────────────────────────
数据不可用                HTTP 404 + 错误消息
ROI未配置                前端提示 "请先配置ROI区域"
参数超范围                FastAPI自动验证 + 422错误
网络连接失败              前端重试机制 + 错误提示
数据处理异常              后端日志记录 + 500错误
```