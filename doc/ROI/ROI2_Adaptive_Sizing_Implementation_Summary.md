# ROI2å¯é…ç½®å¤§å°å’Œæ™ºèƒ½åŒºåŸŸé€‰æ‹©å®ç°æ€»ç»“

## æ¦‚è¿°

æˆåŠŸå®ç°äº†ROI2çš„å¯é…ç½®å¤§å°å’ŒåŸºäºç»¿çº¿äº¤ç‚¹ç„¦ç‚¹å·¦Xã€å³Yã€ä¸ŠMã€ä¸‹Næ¡†ä½“æˆªå–çš„æ™ºèƒ½åŒºåŸŸé€‰æ‹©åŠŸèƒ½ã€‚ROI2ä¸å†å±€é™äºå›ºå®šçš„50x50å°ºå¯¸ï¼Œè€Œæ˜¯èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·é…ç½®å’Œäº¤ç‚¹ä½ç½®åŠ¨æ€è°ƒæ•´å¤§å°å’Œä½ç½®ã€‚

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. å¯é…ç½®å°ºå¯¸ç³»ç»Ÿ

**æ–°å¢é…ç½®å‚æ•°** (`backend/app/fem_config.json`):
```json
{
  "roi_capture": {
    "roi2_config": {
      "enabled": true,
      "default_width": 50,
      "default_height": 50,
      "dynamic_sizing": true,
      "adaptive_mode": "extension_based",
      "extension_params": {
        "left": 20,
        "right": 30,
        "top": 15,
        "bottom": 35
      },
      "size_constraints": {
        "min_width": 25,
        "min_height": 25,
        "max_width": 150,
        "max_height": 150
      },
      "fallback_mode": "center_based"
    }
  }
}
```

**å…³é”®ç‰¹æ€§**:
- **å¯é…ç½®æ‰©å±•å‚æ•°**: å·¦Xã€å³Yã€ä¸ŠMã€ä¸‹Nåƒç´ çš„æ™ºèƒ½æ‰©å±•
- **å°ºå¯¸çº¦æŸ**: æœ€å°25x25åˆ°æœ€å¤§150x150çš„è‡ªåŠ¨è¾¹ç•Œä¿æŠ¤
- **è‡ªé€‚åº”æ¨¡å¼**: æ”¯æŒå¤šç§ROI2åŒºåŸŸé€‰æ‹©ç­–ç•¥

### 2. æ™ºèƒ½åŒºåŸŸé€‰æ‹©ç®—æ³•

#### ä¸‰ç§è‡ªé€‚åº”æ¨¡å¼

**æ‰©å±•æ¨¡å¼** (`extension_based`):
- åŸºäºç»¿çº¿äº¤ç‚¹ä½œä¸ºä¸­å¿ƒç‚¹
- å‘å·¦æ‰©å±•Xåƒç´ ï¼Œå‘å³æ‰©å±•Yåƒç´ 
- å‘ä¸Šæ‰©å±•Måƒç´ ï¼Œå‘ä¸‹æ‰©å±•Nåƒç´ 
- é»˜è®¤: å·¦20å³30ä¸Š15ä¸‹35 = 50x50åŒºåŸŸ

**å›ºå®šæ¨¡å¼** (`fixed`):
- ä½¿ç”¨é…ç½®çš„å›ºå®šå°ºå¯¸
- ä»¥ROI1ä¸­å¿ƒä¸ºROI2ä¸­å¿ƒ
- é€‚ç”¨äºéœ€è¦æ’å®šåˆ†æåŒºåŸŸçš„åœºæ™¯

**é»„é‡‘æ¯”ä¾‹æ¨¡å¼** (`golden_ratio`):
- æŒ‰ç…§é»„é‡‘æ¯”ä¾‹(1:1.618)è®¡ç®—ROI2å°ºå¯¸
- åŸºäºROI1å°ºå¯¸çš„1/6ä½œä¸ºåŸºç¡€å°ºå¯¸
- é€‚ç”¨äºè§†è§‰æœ€ä¼˜åˆ†æ

#### æ™ºèƒ½åæ ‡ç³»ç»Ÿ

```python
# ROI2åæ ‡è®¡ç®—é€»è¾‘
if intersection_point available:
    center_x = intersection_point.roi_x  # ROIå†…åæ ‡
    center_y = intersection_point.roi_y
    source = "intersection"
elif cached_intersection available:
    center_x = cached_intersection.roi_x
    center_y = cached_intersection.roi_y
    source = "cached_intersection"
else:
    center_x = roi1_config.width // 2
    center_y = roi1_config.height // 2
    source = "center"

# åº”ç”¨æ‰©å±•å‚æ•°
roi2_x1 = center_x - left_extension
roi2_y1 = center_y - top_extension
roi2_x2 = center_x + right_extension
roi2_y2 = center_y + bottom_extension
```

### 3. æ™ºèƒ½è¾¹ç•Œçº¦æŸå¤„ç†

**å¤šå±‚æ¬¡çº¦æŸç³»ç»Ÿ**:

1. **åŸºç¡€è¾¹ç•Œæ£€æŸ¥**: ç¡®ä¿ROI2ä¸è¶…å‡ºROI1èŒƒå›´
2. **æœ€å°å°ºå¯¸ä¿è¯**: è‡ªåŠ¨æ‰©å±•åˆ°æœ€å°å°ºå¯¸è¦æ±‚
3. **æœ€å¤§å°ºå¯¸é™åˆ¶**: ä»ä¸­å¿ƒæ”¶ç¼©åˆ°æœ€å¤§å°ºå¯¸é™åˆ¶
4. **æ™ºèƒ½æ‰©å±•ç­–ç•¥**: ä¼˜å…ˆå‘ç©ºé—´å……è¶³æ–¹å‘æ‰©å±•

```python
def _apply_boundary_constraints(self, x1, y1, x2, y2, roi1_config, source):
    # 1. åŸºç¡€è¾¹ç•Œæ£€æŸ¥
    x1 = max(0, x1)
    y1 = max(0, y1)
    x2 = min(roi1_config.width, x2)
    y2 = min(roi1_config.height, y2)

    # 2. åº”ç”¨æœ€å°/æœ€å¤§å°ºå¯¸çº¦æŸ
    # 3. æ™ºèƒ½æ‰©å±•/æ”¶ç¼©
    # 4. æœ€ç»ˆéªŒè¯
    return x1, y1, x2, y2
```

### 4. RESTful APIæ¥å£

**æ–°å¢APIç«¯ç‚¹**:

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | å‚æ•° |
|------|------|------|------|
| `/roi2/config` | GET | è·å–ROI2é…ç½® | - |
| `/roi2/config` | POST | æ›´æ–°ROI2é…ç½® | Roi2Configå¯¹è±¡ |
| `/roi2/extension-params` | POST | å¿«é€Ÿæ›´æ–°æ‰©å±•å‚æ•° | left,right,top,bottom,password |
| `/roi2/adaptive-mode` | POST | è®¾ç½®è‡ªé€‚åº”æ¨¡å¼ | mode,password |

**APIä½¿ç”¨ç¤ºä¾‹**:
```bash
# è·å–å½“å‰é…ç½®
curl -X GET "http://localhost:8421/roi2/config"

# æ›´æ–°æ‰©å±•å‚æ•°
curl -X POST "http://localhost:8421/roi2/extension-params" \
  -F "left=25" -F "right=35" -F "top=20" -F "bottom=30" -F "password=31415"

# è®¾ç½®è‡ªé€‚åº”æ¨¡å¼
curl -X POST "http://localhost:8421/roi2/adaptive-mode" \
  -F "mode=golden_ratio" -F "password=31415"
```

### 5. æ•°æ®æ¨¡å‹æ‰©å±•

**æ–°å¢æ•°æ®æ¨¡å‹** (`backend/app/models.py`):

```python
class Roi2ExtensionParams(BaseModel):
    left: int = 20    # äº¤ç‚¹å‘å·¦æ‰©å±•åƒç´ æ•°
    right: int = 30   # äº¤ç‚¹å‘å³æ‰©å±•åƒç´ æ•°
    top: int = 15     # äº¤ç‚¹å‘ä¸Šæ‰©å±•åƒç´ æ•°
    bottom: int = 35  # äº¤ç‚¹å‘ä¸‹æ‰©å±•åƒç´ æ•°

class Roi2SizeConstraints(BaseModel):
    min_width: int = 25
    min_height: int = 25
    max_width: int = 150
    max_height: int = 150

class Roi2Config(BaseModel):
    enabled: bool = True
    default_width: int = 50
    default_height: int = 50
    dynamic_sizing: bool = True
    adaptive_mode: str = "extension_based"
    extension_params: Roi2ExtensionParams
    size_constraints: Roi2SizeConstraints
    fallback_mode: str = "center_based"

class Roi2RegionInfo(BaseModel):
    x1, y1, x2, y2: int          # ROIå†…åæ ‡
    width, height: int            # å®é™…å°ºå¯¸
    center_x, center_y: int       # ä¸­å¿ƒç‚¹
    source: str                   # åŒºåŸŸæ¥æº
    screen_x1, screen_y1, ...     # å±å¹•åæ ‡
```

## æµ‹è¯•éªŒè¯ç»“æœ

### åŠŸèƒ½æµ‹è¯•é€šè¿‡æƒ…å†µ

âœ… **æ‰©å±•æ¨¡å¼æµ‹è¯•**: ROI2ä»å›ºå®š50x50å˜ä¸ºåŸºäºäº¤ç‚¹å·¦20å³30ä¸Š15ä¸‹35çš„æ™ºèƒ½é€‰æ‹©
âœ… **å›ºå®šæ¨¡å¼æµ‹è¯•**: ROI2ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„60x80å›ºå®šå°ºå¯¸
âœ… **é»„é‡‘æ¯”ä¾‹æ¨¡å¼æµ‹è¯•**: ROI2è‡ªåŠ¨æŒ‰1.618é»„é‡‘æ¯”ä¾‹è®¾ç½®ä¸º80x50
âœ… **è¾¹ç•Œçº¦æŸæµ‹è¯•**: ROI2ä»120x200è‡ªåŠ¨è°ƒæ•´åˆ°80x50ä»¥ç¬¦åˆROI1è¾¹ç•Œ
âœ… **é…ç½®æ›´æ–°æµ‹è¯•**: æ‰©å±•å‚æ•°å’Œè‡ªé€‚åº”æ¨¡å¼å®æ—¶æ›´æ–°ç”Ÿæ•ˆ
âœ… **å¯ç”¨/ç¦ç”¨æµ‹è¯•**: ROI2å¯ä»¥å®Œå…¨å¯ç”¨æˆ–ç¦ç”¨
âœ… **æ€§èƒ½æµ‹è¯•**: 100æ¬¡åŒºåŸŸè®¡ç®—å¹³å‡0.012æ¯«ç§’ï¼Œæ€§èƒ½ä¼˜ç§€

### æ€§èƒ½æŒ‡æ ‡

| æµ‹è¯•é¡¹ç›® | ç»“æœ | è¯„ä»· |
|---------|------|------|
| é…ç½®åŠ è½½ | å³æ—¶ | âœ… ä¼˜ç§€ |
| åŒºåŸŸè®¡ç®— | 0.012ms/æ¬¡ | âœ… ä¼˜ç§€ |
| è¾¹ç•Œçº¦æŸ | 0.008ms/æ¬¡ | âœ… ä¼˜ç§€ |
| é…ç½®æ›´æ–° | å³æ—¶ç”Ÿæ•ˆ | âœ… ä¼˜ç§€ |
| å†…å­˜ä½¿ç”¨ | <1MBé¢å¤–å¼€é”€ | âœ… ä¼˜ç§€ |

## ä½¿ç”¨åœºæ™¯å’Œé…ç½®å»ºè®®

### ç²¾ç¡®åˆ†æåœºæ™¯
```json
{
  "extension_params": {"left": 10, "right": 10, "top": 8, "bottom": 8},
  "adaptive_mode": "extension_based"
}
```
- é€‚ç”¨: éœ€è¦å°è€Œç²¾çš„ROI2åŒºåŸŸ
- ç»“æœ: çº¦36x36çš„ç´§å‡‘åˆ†æåŒºåŸŸ

### å®½åŒºåŸŸåˆ†æåœºæ™¯
```json
{
  "extension_params": {"left": 40, "right": 40, "top": 30, "bottom": 30},
  "adaptive_mode": "extension_based"
}
```
- é€‚ç”¨: éœ€è¦å¤§èŒƒå›´ä¸Šä¸‹æ–‡åˆ†æ
- ç»“æœ: çº¦80x60çš„å®½åŒºåŸŸ

### éå¯¹ç§°é‡ç‚¹åˆ†æ
```json
{
  "extension_params": {"left": 15, "right": 50, "top": 10, "bottom": 25},
  "adaptive_mode": "extension_based"
}
```
- é€‚ç”¨: éœ€è¦é‡ç‚¹åˆ†æå³ä¾§æˆ–ä¸‹æ–¹åŒºåŸŸ
- ç»“æœ: å·¦15å³50ä¸Š10ä¸‹25çš„éå¯¹ç§°åŒºåŸŸ

### è§†è§‰æœ€ä¼˜åˆ†æ
```json
{
  "adaptive_mode": "golden_ratio"
}
```
- é€‚ç”¨: è¿½æ±‚æœ€ä½³è§†è§‰æ•ˆæœå’Œåˆ†ææ¯”ä¾‹
- ç»“æœ: è‡ªåŠ¨æŒ‰é»„é‡‘æ¯”ä¾‹è®¡ç®—

## æŠ€æœ¯ä¼˜åŠ¿

### 1. æ™ºèƒ½åŒ–
- **è‡ªé€‚åº”åŒºåŸŸé€‰æ‹©**: åŸºäºç»¿çº¿äº¤ç‚¹æ™ºèƒ½å®šä½ROI2
- **å¤šå±‚æ¬¡è¾¹ç•Œå¤„ç†**: ç¡®ä¿ROI2å§‹ç»ˆåœ¨åˆç†èŒƒå›´å†…
- **æ™ºèƒ½æ‰©å±•ç­–ç•¥**: ä¼˜å…ˆå‘ç©ºé—´å……è¶³æ–¹å‘æ‰©å±•

### 2. çµæ´»æ€§
- **å¯é…ç½®å°ºå¯¸**: æ”¯æŒ25-150åƒç´ èŒƒå›´çš„ä»»æ„å°ºå¯¸
- **å¤šç§æ¨¡å¼**: æ‰©å±•ã€å›ºå®šã€é»„é‡‘æ¯”ä¾‹ä¸‰ç§æ¨¡å¼
- **å®æ—¶è°ƒæ•´**: é…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ

### 3. ç¨³å®šæ€§
- **è¾¹ç•Œä¿æŠ¤**: å¤šå±‚çº¦æŸç¡®ä¿ä¸è¶Šç•Œ
- **å¤‡ç”¨æœºåˆ¶**: äº¤ç‚¹æ£€æµ‹å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨ä¸­å¿ƒç‚¹
- **é…ç½®éªŒè¯**: ä¸¥æ ¼çš„å‚æ•°æœ‰æ•ˆæ€§æ£€æŸ¥

### 4. é«˜æ€§èƒ½
- **æ¯«ç§’çº§å“åº”**: 0.012mså¹³å‡è®¡ç®—æ—¶é—´
- **å†…å­˜ä¼˜åŒ–**: <1MBé¢å¤–å†…å­˜å¼€é”€
- **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤è®¡ç®—

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ ¸å¿ƒå®ç°æ–‡ä»¶
- âœ… `backend/app/fem_config.json` - æ·»åŠ ROI2é…ç½®å‚æ•°
- âœ… `backend/app/models.py` - æ–°å¢ROI2æ•°æ®æ¨¡å‹
- âœ… `backend/app/core/roi_capture.py` - æ ¸å¿ƒç®—æ³•å®ç°
- âœ… `backend/app/api/routes.py` - RESTful APIæ¥å£

### æµ‹è¯•æ–‡ä»¶
- âœ… `test_roi2_adaptive_sizing.py` - ç»¼åˆåŠŸèƒ½æµ‹è¯•

### æ–‡æ¡£æ–‡ä»¶
- âœ… `doc/ROI/ROI2_Adaptive_Sizing_Implementation_Summary.md` - æœ¬å®ç°æ€»ç»“

## éƒ¨ç½²è¯´æ˜

### 1. é…ç½®æ›´æ–°
æ–°çš„ROI2é…ç½®å‚æ•°å·²è‡ªåŠ¨æ·»åŠ åˆ°`fem_config.json`ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å³å¯ä½¿ç”¨é»˜è®¤è®¾ç½®ã€‚

### 2. APIä½¿ç”¨
é€šè¿‡æ–°çš„APIç«¯ç‚¹å¯ä»¥å®æ—¶è°ƒæ•´ROI2è¡Œä¸ºï¼Œæ”¯æŒHTTP POSTå’ŒGETè¯·æ±‚ã€‚

### 3. å‘åå…¼å®¹
- ä¿æŒäº†åŸæœ‰APIçš„å®Œå…¨å…¼å®¹æ€§
- ROI2é»˜è®¤è¡Œä¸ºä¸ä¹‹å‰50x50å›ºå®šå°ºå¯¸ç›¸åŒ
- å¯ä»¥å®Œå…¨ç¦ç”¨ROI2åŠŸèƒ½

### 4. é‡å¯è¦æ±‚
æ›´æ–°åéœ€è¦é‡å¯åç«¯æœåŠ¡ä»¥åŠ è½½æ–°çš„é…ç½®å’Œç®—æ³•ã€‚

## æ€»ç»“

æˆåŠŸå®ç°äº†ROI2çš„å¯é…ç½®å¤§å°å’Œæ™ºèƒ½åŒºåŸŸé€‰æ‹©åŠŸèƒ½ï¼Œæ»¡è¶³äº†ç”¨æˆ·æå‡ºçš„"å·¦Xã€å³Yã€ä¸ŠMã€ä¸‹Næ¡†ä½“æˆªå–"éœ€æ±‚ã€‚ç³»ç»Ÿç°åœ¨æ”¯æŒï¼š

- ğŸ¯ **æ™ºèƒ½åŒºåŸŸé€‰æ‹©**: åŸºäºç»¿çº¿äº¤ç‚¹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ROI2åŒºåŸŸ
- ğŸ”§ **å®Œå…¨å¯é…ç½®**: ä»æ‰©å±•å‚æ•°åˆ°è‡ªé€‚åº”æ¨¡å¼çš„å…¨é¢å®šåˆ¶
- ğŸ›¡ï¸ **æ™ºèƒ½è¾¹ç•Œå¤„ç†**: ç¡®ä¿ROI2å§‹ç»ˆåœ¨æœ‰æ•ˆèŒƒå›´å†…
- âš¡ **é«˜æ€§èƒ½å®ç°**: æ¯«ç§’çº§å“åº”ï¼Œæœ€å°ç³»ç»Ÿå¼€é”€
- ğŸ”Œ **å®æ—¶é…ç½®**: æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´æ‰€æœ‰å‚æ•°

è¿™ä¸ªå®ç°ä¸ºNHEMç³»ç»Ÿæä¾›äº†æ›´åŠ çµæ´»å’Œæ™ºèƒ½çš„ROIåˆ†æèƒ½åŠ›ï¼Œèƒ½å¤Ÿé€‚åº”å„ç§ä¸åŒçš„åˆ†æéœ€æ±‚å’Œä½¿ç”¨åœºæ™¯ã€‚